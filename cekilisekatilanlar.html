<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Çekilişe Katılanlar</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBXbLpzgMa8wiiYcXhVDsOSRzVx_zdplxw",
      authDomain: "cekilisveritabani.firebaseapp.com",
      projectId: "cekilisveritabani",
      storageBucket: "cekilisveritabani.appspot.com",
      messagingSenderId: "246236686196",
      appId: "1:246236686196:web:d22a9b99140626cc04ae21"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let participants = [];

    async function fetchParticipants() {
      const querySnapshot = await getDocs(collection(db, "participants"));
      participants = [];

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const timestamp = data.timestamp?.toDate();
        const username = data.username;

        if (username) {
          participants.push({
            username,
            timestamp,
          });
        }
      });

      renderParticipants();
    }

    function formatDate(date) {
      if (!date) return "Tarih yok";
      return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()} - ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }

    function maskEmail(email) {
      const [localPart, domain] = email.split('@');
      if (!localPart || !domain) return email;

      if (localPart.length <= 4) {
        return localPart[0] + '*'.repeat(localPart.length - 2) + localPart.slice(-1) + '@' + domain;
      }

      const visibleStart = localPart.slice(0, 2);
      const visibleEnd = localPart.slice(-2);
      const masked = '*'.repeat(localPart.length - 4);

      return visibleStart + masked + visibleEnd + '@' + domain;
    }

    function renderParticipants() {
      const searchValue = document.getElementById("search").value.toLowerCase();
      const sortValue = document.getElementById("sort").value;
      const listElement = document.getElementById("participantList");
      const countElement = document.getElementById("totalCount");

      let filtered = participants.filter(p => p.username.toLowerCase().includes(searchValue));

      filtered.sort((a, b) => {
        if (sortValue === "newest") return b.timestamp - a.timestamp;
        if (sortValue === "oldest") return a.timestamp - b.timestamp;
        if (sortValue === "az") return a.username.localeCompare(b.username);
        if (sortValue === "za") return b.username.localeCompare(a.username);
        return 0;
      });

      listElement.innerHTML = "";
      filtered.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${maskEmail(p.username)} (${formatDate(p.timestamp)})`;
        listElement.appendChild(li);
      });

      countElement.textContent = filtered.length;
    }

    function downloadCSV() {
      let csv = "Kullanıcı Adı,Tarih/Saat\n";
      participants.forEach(p => {
        csv += `"${p.username}","${formatDate(p.timestamp)}"\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "cekilise_katilanlar.csv";
      link.click();
    }

    window.addEventListener("DOMContentLoaded", () => {
      fetchParticipants();
      document.getElementById("search").addEventListener("input", renderParticipants);
      document.getElementById("sort").addEventListener("change", renderParticipants);
      document.getElementById("downloadCSV").addEventListener("click", downloadCSV);
    });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    .container {
      background: white;
      padding: 30px;
      max-width: 700px;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    ul {
      list-style-type: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    li {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    h2 {
      margin-bottom: 10px;
    }
    .top-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .count {
      margin-top: 15px;
      font-weight: bold;
      color: #2c3e50;
    }
    button {
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Çekilişe Katılanlar</h2>
    <div class="top-controls">
      <input type="text" id="search" placeholder="İsim ara...">
      <select id="sort">
        <option value="newest">Katılma Tarihi (En Yeni)</option>
        <option value="oldest">Katılma Tarihi (En Eski)</option>
        <option value="az">A'dan Z'ye</option>
        <option value="za">Z'den A'ya</option>
      </select>
      <button id="downloadCSV">CSV İndir</button>
    </div>
    <ul id="participantList"></ul>
    <div class="count">Toplam Katılımcı: <span id="totalCount">0</span></div>
  </div>
</body>
</html>
